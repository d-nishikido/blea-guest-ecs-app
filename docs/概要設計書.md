# BLEA Guest ECS アプリケーション概要設計書

## 1. システム概要

### 1.1 プロジェクト概要
本プロジェクトは、AWS上でコンテナ化されたWebアプリケーションを実行するための基盤環境（BLEA: Baseline Environment on AWS）のサンプル実装です。ECS/Fargateを使用したコンテナオーケストレーション、Aurora PostgreSQLデータベース、CloudFrontによるコンテンツ配信、包括的な監視機能を提供します。

### 1.2 システムの目的
- セキュアでスケーラブルなコンテナベースのWebアプリケーション基盤の提供
- AWSベストプラクティスに準拠した本番環境対応のアーキテクチャ
- 包括的な監視とアラート機能による高可用性の実現
- Infrastructure as Code（IaC）によるインフラ管理の自動化

### 1.3 主要技術スタック
- **インフラ管理**: AWS CDK v2（TypeScript）
- **コンテナオーケストレーション**: Amazon ECS on Fargate
- **データベース**: Amazon Aurora PostgreSQL
- **CDN**: Amazon CloudFront
- **監視**: Amazon CloudWatch, AWS Synthetics

## 2. アーキテクチャ設計

### 2.1 全体アーキテクチャ

```
インターネット
    ↓
CloudFront（CDN）
    ↓
AWS WAF（Webアプリケーションファイアウォール）
    ↓
Application Load Balancer（ALB）
    ↓
ECS Fargate（コンテナ）
    ↓
Aurora PostgreSQL（データベース）
```

### 2.2 スタック構成

#### 2.2.1 バックエンドスタック（BLEAEcsAppStack）
- **責務**: コアインフラストラクチャとバックエンドサービスの管理
- **主要コンポーネント**:
  - VPCネットワーク
  - ECSクラスタとサービス
  - Aurora PostgreSQLデータベース
  - Application Load Balancer
  - KMS暗号化キー

#### 2.2.2 フロントエンドスタック（BLEAEcsAppFrontendStack）
- **責務**: CDNとWebセキュリティの管理
- **主要コンポーネント**:
  - CloudFrontディストリビューション
  - AWS WAF v2
  - 静的コンテンツ用S3バケット
  - カスタムドメイン対応（オプション）

#### 2.2.3 監視スタック（BLEAEcsAppMonitoringStack）
- **責務**: システム全体の監視と可観測性
- **主要コンポーネント**:
  - CloudWatchダッシュボード
  - Syntheticsカナリー
  - アラーム設定
  - 通知設定（Email/Slack）

#### 2.2.4 パイプラインスタック（BLEAEcsAppPipelineStack）
- **責務**: CI/CDパイプラインの管理
- **主要コンポーネント**:
  - CodePipeline
  - CodeBuild
  - GitHub連携（CodeStar Connections）

### 2.3 主要コンストラクト

| コンストラクト | 説明 | 実装ファイル |
|--------------|------|------------|
| Networking | VPCとサブネット構成 | `lib/construct/networking.ts` |
| Datastore | Aurora PostgreSQLクラスタ | `lib/construct/datastore.ts` |
| EcsApp | ECSサービスと自動スケーリング | `lib/construct/ecsapp.ts` |
| Frontend | CloudFrontとWAF設定 | `lib/construct/frontend.ts` |
| Monitoring | SNSトピックとアラート基盤 | `lib/construct/monitoring.ts` |
| Dashboard | CloudWatchダッシュボード | `lib/construct/dashboard.ts` |
| Canary | Synthetics監視 | `lib/construct/canary.ts` |

## 3. ネットワーク設計

### 3.1 VPC構成
- **CIDR範囲**: 設定可能（デフォルト: 10.100.0.0/16）
- **可用性ゾーン**: 2つのAZに跨る構成
- **NATゲートウェイ**: コスト最適化のため単一NAT

### 3.2 サブネット設計

| サブネット種別 | CIDR | 用途 | インターネット接続 |
|-------------|------|------|-----------------|
| パブリック | /24 | ALB配置 | 直接接続 |
| プライベート | /22 | ECSタスク | NAT経由 |
| プロテクテッド | /22 | Aurora DB | 接続なし |

### 3.3 VPCエンドポイント
- **ゲートウェイエンドポイント**: S3
- **インターフェースエンドポイント**: 
  - ECR（API、DKR）
  - CloudWatch Logs
  - Systems Manager
  - EC2

### 3.4 セキュリティグループ

| セキュリティグループ | インバウンド | アウトバウンド |
|------------------|------------|-------------|
| ALB | HTTP(80), HTTPS(443) from Internet | ECSタスク向け |
| ECSタスク | ALBからのトラフィック | すべて許可 |
| Aurora | ECSタスクからPostgreSQL(5432) | なし |

## 4. コンピューティング設計

### 4.1 ECS構成
- **起動タイプ**: Fargate
- **プラットフォームバージョン**: LATEST
- **タスク定義**:
  - CPU: 1024（1 vCPU）
  - メモリ: 2048 MB
  - ネットワークモード: awsvpc

### 4.2 自動スケーリング設定

| 設定項目 | 値 |
|---------|-----|
| 最小タスク数 | 2 |
| 最大タスク数 | 10 |
| CPU使用率ターゲット | 50% |
| リクエスト数ターゲット | 10,000リクエスト/ターゲット |

### 4.3 コンテナ設定
- **イメージ**: Amazon ECR パブリックギャラリー
- **ログ**: CloudWatch Logsに出力
- **ヘルスチェック**: ALB経由でHTTPヘルスチェック

## 5. データベース設計

### 5.1 Aurora PostgreSQL構成
- **エンジンバージョン**: Aurora PostgreSQL 11.9
- **クラスタ構成**: 
  - ライターインスタンス: 1台
  - リーダーインスタンス: 1台
- **インスタンスタイプ**: t3.medium
- **ストレージ暗号化**: KMS CMKによる暗号化

### 5.2 バックアップとリカバリ
- **自動バックアップ**: 有効
- **バックアップ保持期間**: 設定可能
- **スナップショット**: 暗号化されたスナップショット
- **Performance Insights**: 有効（KMS暗号化）

### 5.3 監視設定
- **メトリクス**: CPU使用率、接続数、レイテンシー
- **ログ**: PostgreSQLログをCloudWatchに出力
- **アラーム**: CPU使用率、接続数の閾値監視

## 6. CDN/フロントエンド設計

### 6.1 CloudFront設定
- **オリジン**: Application Load Balancer
- **ビヘイビア**:
  - デフォルト: 動的コンテンツ（キャッシュ無効）
  - `/static/*`: 静的コンテンツ（キャッシュ有効）
- **プロトコル**: HTTPS強制（HTTPからリダイレクト）
- **ログ**: S3バケットへのアクセスログ

### 6.2 WAF設定

| ルールセット | 説明 |
|------------|------|
| 共通ルール | OWASP Top 10対策 |
| 既知の不正入力 | 既知の攻撃パターン |
| IP評価リスト | 悪意のあるIPアドレス |
| Linuxルール | Linux固有の脆弱性対策 |
| SQLインジェクション | SQLi攻撃対策 |

### 6.3 静的コンテンツ配信
- **S3バケット**: バージョニング有効
- **アクセス制御**: CloudFront経由のみ許可
- **エラーページ**: カスタム403エラーページ

## 7. セキュリティ設計

### 7.1 暗号化
- **保存データ**: 
  - KMS CMKによる暗号化（Aurora、CloudWatch Logs、S3）
  - 自動キーローテーション有効
- **転送中データ**: 
  - 全サービスでSSL/TLS強制
  - ALB-ECS間もHTTPS通信

### 7.2 アクセス制御
- **IAMロール**: 最小権限の原則に基づく設計
- **サービスロール**: 
  - ECSタスク実行ロール
  - ECSタスクロール
  - Lambda実行ロール
- **リソースポリシー**: S3バケットポリシーによる制御

### 7.3 ネットワークセキュリティ
- **多層防御**: WAF → ALB → セキュリティグループ → NACL
- **ネットワーク分離**: パブリック/プライベート/プロテクテッドサブネット
- **VPCフローログ**: 全トラフィックの記録と分析

### 7.4 コンプライアンス
- **ログ保管**: 全サービスログの集約と保管
- **監査証跡**: CloudTrailによる操作記録（将来実装）
- **暗号化標準**: AWS KMSによる業界標準暗号化

## 8. 監視・運用設計

### 8.1 CloudWatchメトリクス

| カテゴリ | 監視項目 |
|---------|---------|
| ECS | CPU使用率、メモリ使用率、タスク数 |
| ALB | レスポンスタイム、HTTPエラー率、接続エラー |
| Aurora | CPU使用率、接続数、レイテンシー |
| CloudFront | リクエスト数、エラー率、オリジンレイテンシー |

### 8.2 アラーム設定

| アラーム | 閾値 | アクション |
|---------|------|----------|
| ECS CPU高使用率 | > 80% | SNS通知 |
| ALB 5xxエラー | > 10/分 | SNS通知 |
| Aurora CPU高使用率 | > 80% | SNS通知 |
| カナリー失敗 | 2回連続失敗 | SNS通知 |

### 8.3 ダッシュボード構成
- **概要ビュー**: システム全体の健全性
- **パフォーマンスビュー**: レスポンスタイムとスループット
- **エラービュー**: 各層のエラー率
- **リソース使用状況**: CPU、メモリ、ネットワーク

### 8.4 Syntheticsカナリー
- **監視間隔**: 5分ごと
- **監視内容**: エンドポイントの可用性とレスポンスタイム
- **アラート**: 2回連続失敗時に通知

### 8.5 通知設定
- **Email通知**: SNS経由でのメール送信
- **Slack通知**: AWS Chatbot経由でのSlack連携
- **通知内容**: アラーム名、状態、タイムスタンプ

## 9. CI/CDパイプライン設計

### 9.1 パイプライン構成
1. **ソース**: GitHub（CodeStar Connections経由）
2. **ビルド**: CodeBuild（CDKシンセサイズ）
3. **デプロイ**: CDK Deploy（自己更新可能）

### 9.2 環境戦略
- **開発環境**: 自動デプロイ
- **本番環境**: 手動承認後デプロイ（将来実装）
- **ブランチ戦略**: mainブランチからのデプロイ

### 9.3 セキュリティ
- **クロスアカウント**: 信頼関係によるデプロイ
- **シークレット管理**: Systems Manager Parameter Store
- **監査**: パイプライン実行ログの保管

## 10. 災害復旧計画

### 10.1 バックアップ戦略
- **データベース**: 自動バックアップ + 手動スナップショット
- **設定情報**: Infrastructure as Codeによる再現性
- **ログ**: S3への長期保管

### 10.2 復旧目標
- **RPO（目標復旧時点）**: 1時間
- **RTO（目標復旧時間）**: 4時間
- **可用性目標**: 99.9%

### 10.3 フェイルオーバー
- **ECS**: 複数AZでの自動復旧
- **Aurora**: 自動フェイルオーバー
- **CloudFront**: グローバルな冗長性

## 11. コスト最適化

### 11.1 実装済み最適化
- **単一NATゲートウェイ**: 開発環境でのコスト削減
- **t3.mediumインスタンス**: 開発環境用の小規模インスタンス
- **S3ライフサイクル**: ログの自動アーカイブ（将来実装）

### 11.2 将来の最適化案
- **Fargate Spot**: スポットインスタンスの活用
- **予約インスタンス**: 本番環境での割引
- **オートスケーリング**: 需要に応じた自動調整

## 12. 今後の拡張計画

### 12.1 短期計画
- [ ] カスタムドメインの実装
- [ ] 本番環境用パラメータの追加
- [ ] CloudTrailの導入
- [ ] Secrets Managerの統合

### 12.2 中期計画
- [ ] マルチリージョン対応
- [ ] ブルーグリーンデプロイメント
- [ ] API Gateway統合
- [ ] コンテナイメージのセキュリティスキャン

### 12.3 長期計画
- [ ] サービスメッシュ（App Mesh）導入
- [ ] 分散トレーシング強化
- [ ] 機械学習による異常検知
- [ ] コスト分析ダッシュボード

## 付録A: パラメータ一覧

### 必須パラメータ
| パラメータ | 説明 | デフォルト値 |
|----------|------|------------|
| envName | 環境名 | Development |
| vpcCidr | VPC CIDR | 10.100.0.0/16 |
| monitoringNotifyEmail | 通知先メール | - |
| monitoringSlackWorkspaceId | Slack ワークスペースID | - |
| monitoringSlackChannelId | Slack チャンネルID | - |

### オプションパラメータ
| パラメータ | 説明 | デフォルト値 |
|----------|------|------------|
| hostedZoneId | Route 53 ホストゾーンID | - |
| domainName | カスタムドメイン名 | - |
| cloudFrontHostName | CloudFrontホスト名 | - |

## 付録B: ディレクトリ構造

```
blea-guest-ecs-app/
├── bin/                          # CDKアプリケーションエントリポイント
│   ├── blea-guest-ecs-app-sample.ts
│   └── blea-guest-ecs-app-sample-via-cdk-pipelines.ts
├── lib/
│   ├── construct/               # 再利用可能なコンストラクト
│   │   ├── canary.ts
│   │   ├── dashboard.ts
│   │   ├── datastore.ts
│   │   ├── ecsapp.ts
│   │   ├── frontend.ts
│   │   ├── monitoring.ts
│   │   └── networking.ts
│   ├── stack/                   # CDKスタック定義
│   │   ├── blea-guest-ecs-app-frontend-stack.ts
│   │   ├── blea-guest-ecs-app-monitoring-stack.ts
│   │   ├── blea-guest-ecs-app-sample-stack.ts
│   │   └── blea-guest-ecs-app-sample-via-cdk-pipelines-stack.ts
│   └── stage/                   # CDKステージ定義
│       └── blea-guest-ecs-app-sample-stage.ts
├── test/                        # テストファイル
├── docs/                        # ドキュメント
│   └── 概要設計書.md
├── parameter.ts                 # 環境パラメータ
├── package.json                 # プロジェクト設定
├── tsconfig.json               # TypeScript設定
├── cdk.json                    # CDK設定
└── CLAUDE.md                   # 開発者ガイド
```

## 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|--------|
| 1.0 | 2025-08-21 | 初版作成 | Claude |

---

本設計書は、BLEA Guest ECS アプリケーションの全体像を包括的に記述したものです。実装の詳細については、各ソースコードおよびCLAUDE.mdファイルを参照してください。